#!/bin/sh -e

. /usr/share/debconf/confmodule

CONFIG_DO_WHAT="$1"
CONFIG_ARG2="$2"

CRONTAB=/etc/cron.d/wwwoffle

if [ $# -gt 1 ]; then shift 2; fi

# set defaults in debconf from the config files
PARENT_PROXY=$( perl -e '$proxy="";while(<>){if (m,^(\s*<http://[^>a-z0-9]+>)?\s*proxy\s*=\s*(\S+),) {$proxy=$2;}}print $proxy;' /etc/wwwoffle/wwwoffle.conf 2>/dev/null )
if [ -z "$PARENT_PROXY" ]; then PARENT_PROXY=none; fi
db_set wwwoffle/string_parent_proxy "$PARENT_PROXY" # put config file data into debconf

WWWOFFLE_PORT=$( perl -e '$port="";while(<>){if (m,^\s*http-port\s*=\s*(\S+),) {$port=$1;}}print $port;' /etc/wwwoffle/wwwoffle.conf 2>/dev/null )
if [ -n "$WWWOFFLE_PORT" ]; then
    db_set wwwoffle/string_port_number "$WWWOFFLE_PORT" # put config file data into debconf
fi

if [ -s /etc/wwwoffle/wwwoffle.options ]; then
    if grep -qsx ppp /etc/wwwoffle/wwwoffle.options; then
        db_set wwwoffle/use-ppp-interface true
    else
        db_set wwwoffle/use-ppp-interface false
    fi
    if grep -qsx fetch /etc/wwwoffle/wwwoffle.options; then
        db_set wwwoffle/ppp-fetch true
    else
        db_set wwwoffle/ppp-fetch false
    fi
    if grep -qsx htdig /etc/wwwoffle/wwwoffle.options; then
        db_set wwwoffle/use-htdig true
    else
        db_set wwwoffle/use-htdig false
    fi
fi

if [ -s /etc/cron.d/wwwoffle ]; then
    FREQ=$( perl -ne 'if (m,^[^ \t#]+/(\d+).*wwwoffle.cron-fetch,){print $1;exit;} if (m,^\s*#\s*.*wwwoffle.cron-fetch,) {print "off";exit;}' /etc/cron.d/wwwoffle )
    # convert to digits only
    if [ "$FREQ" != off ]; then FREQ=$( expr "$FREQ" : '\([0-9]*\)' ); fi
    if [ -n "$FREQ" ]; then
        db_set wwwoffle/fetchfrequency $FREQ
    fi
fi
db_subst wwwoffle/string_parent_proxy PARENT_PROXY "$PARENT_PROXY"
db_input medium wwwoffle/select_html_lang || true
db_input low wwwoffle/string_port_number || true
db_input medium wwwoffle/string_parent_proxy || true
db_go || true
db_get wwwoffle/string_parent_proxy || true
db_input high wwwoffle/use-ppp-interface || true
db_go || true
db_get wwwoffle/use-ppp-interface || true
if [ x"$RET" = xtrue ]; then
    db_input medium wwwoffle/ppp-fetch || true
fi
if [ -d /etc/cron.d ]; then
    x=1
    while true; do
        db_input medium wwwoffle/fetchfrequency || true
        rc=$?
        if [    $rc = 30  ]; then break; fi
        db_go || true
        db_get wwwoffle/fetchfrequency || true
        rc=$?
        if [    $rc = 30  ]; then break; fi
        if [ "$RET" = off ]; then break; fi
        # get only digits
        FREQ=$( expr "$RET" : '\([0-9]*\)' ); if [ -z "$FREQ" ]; then FREQ=9999; fi
        # break if value less than or equal to 30
        if [ "$FREQ" -le 30 ]; then
            # if [ ! -f $CRONTAB ]; then # see #327049
            #     db_input medium wwwoffle/nocrontab || true
            #     db_go || true
            # fi
            break
        fi
        # else loop
        sleep 2
        if [ $x -ge 8 ]; then exit 1; fi # emergency brake
        x=$(( $x + 1 ))
    done
fi

# check whether htdig is (to be) installed
echo "Checking for htdig package..."
if [ "`dpkg -l htdig | grep htdig | cut -c1`" = i ]; then
    db_input medium wwwoffle/use-htdig || true
fi
[ -s /etc/wwwoffle.conf -a -d /var/spool/wwwoffle ] && db_input low wwwoffle/text_new_location

if password=$( perl -ne 'if (/^\s*password\s*=\s*(\S*)/) { if ($1 eq "none") { print "secret"; exit 1; } else { print "$1"; exit 1; }}' /etc/wwwoffle/wwwoffle.conf 2>/dev/null ); then
    # password line not found, assume none
    password=secret     # default value
fi

db_set wwwoffle/passwd "$password" || true
db_input high wwwoffle/passwd || true
db_go || true
