#!/usr/bin/make -f

DIR=`pwd`/debian/wwwoffle

build: build-stamp
build-stamp:
	dh_testdir
	touch build

clean:
	dh_testdir
	dh_testroot
	rm -f build build-stamp tags
	if [ -f Makefile ]; then make distclean; fi
	-rm -f `find . -name "*~"`
	dh_clean
	debconf-updatepo
	# These are included in the tarfile, but are regenerated anyway,
	# so I remove them here to prevent the diff being too large.
	rm -f cache/html/??/README.CONF.html cache/html/??/messages/README.CONF.txt
	rm -f doc/wwwoffle.conf.man doc/fr/wwwoffle.conf.man
	rm -f config.log config.status
	rm -f doc/fr/wwwoffle.conf.man.install
	rm -f debian/substvars
	# replace original version
	if [ -f src/wwwoffles.c.original ]; then rm -f src/wwwoffles.c; mv src/wwwoffles.c.original src/wwwoffles.c; fi
	@echo
	# I once forgot this...
	@echo 'Is "$$current_version" in wwwoffle.postinst up to date?'
	@echo 'And have you updated debian/wwwoffle.conf?'
	@echo
	@sleep 2

binary-indep: build
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs

	################################################### MAKE ###########
	# docdir was manually edited in doc/Makefile.in, no option for it
	./autogen.sh
	./configure --prefix=/usr --with-ipv6 --with-spooldir=/var/cache/wwwoffle --with-confdir=/etc/wwwoffle --mandir=/usr/share/man
	make
	make install DESTDIR=$(DIR)

	# Rearrange the installed stuff so that non-volatile stuff isn't below
	# /var/cache/wwwoffle. /usr/share/wwwoffle is a better home for it.
	# OR: should these be user-configurable? In that case, they would have
	#     to be below /etc but that would suck.
	# UPDATE (2.8-2): Below /etc there are symlinks to the directories
	#     containing the real files. Those symlinks can be replaced by real
	#     directories containing real files which can be edited, and that
	#     should work just fine.

	rm -rf $(DIR)/usr/share/wwwoffle/html
	mv $(DIR)/var/cache/wwwoffle/html $(DIR)/usr/share/wwwoffle/.

	# symlink those locations to the original place (would also happen in
	# the init.d script).
	ln -s /etc/wwwoffle/html $(DIR)/var/cache/wwwoffle/.

	# The search/*/conf things are configurable,
	# the search/*/scripts things shouldn't be under /var/cache
	# so move these things around
	# (conf to /etc/wwwoffle/*, scripts to /usr/share/wwwoffle/search/*)
	rm -rf $(DIR)/etc/wwwoffle/search $(DIR)/usr/share/wwwoffle/search
	mkdir -p $(DIR)/etc/wwwoffle
	for i in htdig mnogosearch namazu hyperestraier; do \
	    mkdir $(DIR)/etc/wwwoffle/$$i; \
	    mkdir -p $(DIR)/usr/share/wwwoffle/search/$$i; \
	    mv $(DIR)/var/cache/wwwoffle/search/$$i/conf/*    $(DIR)/etc/wwwoffle/$$i; \
	    mv $(DIR)/var/cache/wwwoffle/search/$$i/scripts/* $(DIR)/usr/share/wwwoffle/search/$$i; \
	    rm -rf $(DIR)/var/cache/wwwoffle/search/$$i/conf $(DIR)/var/cache/wwwoffle/search/$$i/scripts; \
	    ln -s /etc/wwwoffle/$$i                        $(DIR)/var/cache/wwwoffle/search/$$i/conf; \
	    ln -s /usr/share/wwwoffle/search/$$i           $(DIR)/var/cache/wwwoffle/search/$$i/scripts; \
	    done

	# also make these replaceable by the user
	mv $(DIR)/var/cache/wwwoffle/search/namazu/db/NMZ* $(DIR)/etc/wwwoffle/namazu

	# The monitor directory is in /var/lib/wwwoffle
	rm -rf $(DIR)/var/cache/wwwoffle/monitor
	ln -s ../../lib/wwwoffle/monitor $(DIR)/var/cache/wwwoffle/.

	# the default language is chosen via debconf,
	# so remove the link from the package.
	rm -f $(DIR)/usr/share/wwwoffle/html/default

	# the CGI script should be in /usr/lib/cgi-bin
	mv $(DIR)/usr/share/wwwoffle/search/htdig/wwwoffle-htsearch $(DIR)/usr/lib/cgi-bin/.

	# The upgrade scripts / programs
	install -m 755 conf/upgrade-config-2.5-2.6.pl $(DIR)/usr/lib/wwwoffle/
	install -m 755 conf/upgrade-config-2.6-2.7.pl $(DIR)/usr/lib/wwwoffle/
	install -m 755 conf/upgrade-config-2.7-2.8.pl $(DIR)/usr/lib/wwwoffle/
	install -m 755 conf/upgrade-config.pl         $(DIR)/usr/lib/wwwoffle/

	# Throw out the request for wwwoffle's homepage.
	# It's a cute idea, but I'd have to figure out something so that it
	# doesn't get done on every upgrade. Until now I delete it.
	rm -f $(DIR)/var/cache/wwwoffle/outgoing/*

	################################################# CONFIGURATION ####
	# The config file goes to /usr/share/wwwoffle/default,
	# not to /etc/wwwoffle/wwwoffle.conf because it mustn't be a conffile
	#
	rm -f $(DIR)/etc/wwwoffle/wwwoffle.conf
	install -m 644 -g proxy conf/wwwoffle.conf	$(DIR)/usr/share/wwwoffle/default/
	install -m 644 debian/wwwoffle.options		$(DIR)/usr/share/wwwoffle/default/
	install -m 644 debian/wwwoffle.logrotate.d	$(DIR)/etc/logrotate.d/wwwoffle
	dh_installman debian/wwwoffle.options.man

	# move the replacement files around, so that the admin can change the
	# replacement files himself in /etc/wwwoffle/.
	# The (default) symlinks to these files are made in the postinst.
	for i in gif png js; do \
	    mv $(DIR)/usr/share/wwwoffle/html/en/local/dontget/replacement.$$i $(DIR)/usr/share/wwwoffle/html/en/local/dontget/standard.replacement.$$i; \
	    ln -s /etc/wwwoffle/debian-replacement.$$i $(DIR)/usr/share/wwwoffle/html/en/local/dontget/replacement.$$i; \
	done

	# The .pac and robots.txt files are also configurable
	mv $(DIR)/usr/share/wwwoffle/html/en/wwwoffle.pac $(DIR)/etc/wwwoffle
	# remove any others to prevent confusion
	rm -f $(DIR)/usr/share/wwwoffle/html/*/wwwoffle.pac
	ln -s /etc/wwwoffle/wwwoffle.pac $(DIR)/usr/share/wwwoffle/html/en/

	mv $(DIR)/usr/share/wwwoffle/html/en/robots.txt $(DIR)/etc/wwwoffle
	# remove any others to prevent confusion
	rm -f $(DIR)/usr/share/wwwoffle/html/*/robots.txt
	ln -s /etc/wwwoffle/robots.txt $(DIR)/usr/share/wwwoffle/html/en/

	install -m 755 debian/wwwoffle.cron-fetch  $(DIR)/etc/wwwoffle/

	# the ppp scripts
	#
	install -m 755 debian/wwwoffle.ip-up.d          $(DIR)/etc/ppp/ip-up.d/1wwwoffle
	install -m 644 debian/wwwoffle.ip-up.d.subpart_ $(DIR)/etc/ppp/ip-up.d/1wwwoffle.subpart_
	install -m 755 debian/wwwoffle.ip-down.d        $(DIR)/etc/ppp/ip-down.d/99wwwoffle

	################################################## EXTRAS ###########
	install -m 755 contrib/logfile/audit-usage.pl    $(DIR)/usr/sbin/wwwoffle-audit-usage
	install -m 755 contrib/config/wwwoffle-config.pl $(DIR)/usr/share/doc/wwwoffle/contrib/.
	install -m 755 contrib/auto/post-wwwoffle.sh     $(DIR)/usr/share/doc/wwwoffle/contrib/.
	install -m 644 contrib/bookmarklets/bookmarks.html  $(DIR)/usr/share/doc/wwwoffle/contrib/.
	install -m 644 contrib/dontget/*                 $(DIR)/usr/share/doc/wwwoffle/contrib/dontget/.
	install -m 644 contrib/duplicates/*              $(DIR)/usr/share/doc/wwwoffle/contrib/duplicates/.
	install -m 644 contrib/README                    $(DIR)/usr/share/doc/wwwoffle/contrib/.
	install -m 644 debian/wwwoffle-audit-usage.man   $(DIR)/usr/share/man/man8/wwwoffle-audit-usage.8

	################################################## DOCUMENTATION ####
	# Documentation is now installed by "make install".
	# However, too much is installed.
	rm -f $(DIR)/usr/share/doc/wwwoffle/COPYING
	rm -f $(DIR)/usr/share/doc/wwwoffle/INSTALL
	rm -f $(DIR)/usr/share/doc/wwwoffle/README.win32
	rm -f $(DIR)/usr/share/doc/wwwoffle/de/INSTALL
	rm -f $(DIR)/usr/share/doc/wwwoffle/es/INSTALL
	rm -f $(DIR)/usr/share/doc/wwwoffle/es/README.win32
	rm -f $(DIR)/usr/share/doc/wwwoffle/pl/INSTALL
	-rmdir $(DIR)/usr/share/doc/wwwoffle/* 2>/dev/null

	# The "de" README.CONF.html isn't generated for some reason, but is
	# included in the tarball. This results in it being installed in the
	# wrong location. Fix that here.
	if [ -s $(DIR)/usr/share/wwwoffle/html/de/README.CONF.html ]; then \
	    rm -f $(DIR)/usr/share/doc/wwwoffle/de/README.CONF.html; \
	else \
	    mv $(DIR)/usr/share/doc/wwwoffle/de/README.CONF.html $(DIR)/usr/share/wwwoffle/html/de/README.CONF.html; \
	fi

	install -m 644 doc/ANNOUNCE                  $(DIR)/usr/share/doc/wwwoffle/.
	install -m 644 debian/wwwoffle.README.debian $(DIR)/usr/share/doc/wwwoffle/README.Debian

	dh_installman debian/wwwoffle-tools.man
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-ls.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-rm.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-mv.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-read.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-write.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-hash.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-fsck.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-gunzip.8
	ln -sf wwwoffle-tools.8 $(DIR)/usr/share/man/man8/wwwoffle-gzip.8
	dh_installchangelogs ChangeLog

	install -m 644 debian/copyright $(DIR)/usr/share/doc/wwwoffle/.


	###################################################### STUFF #######
	# override postinst-uses-db-input because that only happens in very
	# very seldom circumstances, and it's not worth bothering with.
	mkdir -p $(DIR)/usr/share/lintian/overrides
	install -m 644 debian/wwwoffle.lintian-overrides $(DIR)/usr/share/lintian/overrides/wwwoffle
	dh_installdebconf
	# dh_installmenu
	dh_installcron
	dh_installinit
	dh_strip
	dh_compress
	dh_fixperms
	dh_makeshlibs
	dh_shlibdeps
	dh_gencontrol
	dh_installdeb
	dh_md5sums

	(cd $(DIR); find etc ! -type d | sort | sed 's,^,/,') > $(DIR)/DEBIAN/conffiles

	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary binary-arch binary-indep
